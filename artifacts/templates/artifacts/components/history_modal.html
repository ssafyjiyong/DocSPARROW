<!-- History Modal -->
<div x-data="{ 
    show: false, 
    loading: false, 
    productName: '', 
    categoryName: '', 
    history: [],
    productId: null,
    categoryId: null,
    currentUserId: null,
    isStaff: false
}" 
x-on:modal-open.window="show = true; loading = $event.detail.loading; productName = $event.detail.productName; categoryName = $event.detail.categoryName; history = $event.detail.history; productId = $event.detail.productId; categoryId = $event.detail.categoryId; currentUserId = $event.detail.currentUserId; isStaff = $event.detail.isStaff"
x-on:modal-close.window="show = false"
x-show="show"
x-cloak
class="fixed inset-0 z-50 overflow-y-auto"
x-transition:enter="transition ease-out duration-300"
x-transition:enter-start="opacity-0"
x-transition:enter-end="opacity-100"
x-transition:leave="transition ease-in duration-200"
x-transition:leave-start="opacity-100"
x-transition:leave-end="opacity-0">

    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeModal()"></div>
    
    <!-- Modal Content -->
    <div class="flex min-h-full items-center justify-center p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-history text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white" x-text="productName + ' - ' + categoryName"></h3>
                            <p class="text-blue-100 text-sm">업로드 히스토리</p>
                        </div>
                    </div>
                    <button @click="closeModal()" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-xl flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-white text-lg"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 max-h-96 overflow-y-auto">
                <!-- Loading State -->
                <div x-show="loading" class="flex items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                </div>
                
                <!-- Empty State -->
                <div x-show="!loading && history.length === 0" class="text-center py-12">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-regular fa-folder-open text-slate-400 text-3xl"></i>
                    </div>
                    <p class="text-slate-500 font-medium">등록된 산출물이 없습니다</p>
                    <p class="text-slate-400 text-sm mt-1">아래에서 새로운 산출물을 업로드하세요</p>
                </div>
                
                <!-- History List -->
                <div x-show="!loading && history.length > 0" class="space-y-3">
                    <template x-for="item in history" :key="item.id">
                        <div class="group bg-gradient-to-r from-slate-50 to-slate-100 hover:from-blue-50 hover:to-indigo-50 rounded-xl p-4 border border-slate-200 hover:border-blue-300 transition-all">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg shadow-sm flex items-center justify-center">
                                        <i class="fas fa-file-pdf text-red-500"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-slate-800 truncate max-w-xs" x-text="item.filename" :title="item.filename"></div>
                                        <div class="flex items-center gap-3 text-sm text-slate-500 mt-0.5">
                                            <span><i class="fas fa-tag mr-1"></i> v<span x-text="item.version"></span></span>
                                            <span><i class="fas fa-user mr-1"></i> <span x-text="item.uploader"></span></span>
                                            <span><i class="fas fa-calendar mr-1"></i> <span x-text="item.created_at"></span></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a :href="'/download/' + item.id + '/'" class="w-9 h-9 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center justify-center transition-colors shadow-sm" title="다운로드">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <!-- Show delete button if user is admin OR uploader -->
                                    <button x-show="isStaff || (currentUserId && item.uploader_id === currentUserId)" 
                                            @click="deleteArtifact(item.id, item.filename)" 
                                            class="w-9 h-9 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center transition-colors shadow-sm" 
                                            title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Upload Form -->
            {% if user.is_authenticated %}
            <div class="bg-gradient-to-r from-slate-50 to-slate-100 px-6 py-5 border-t border-slate-200">
                <h4 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt text-blue-500"></i>
                    새 산출물 업로드
                </h4>
                <form @submit.prevent="uploadFile(productId, categoryId, new FormData($el))" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">버전 번호 *</label>
                            <input type="text" name="version_string" required placeholder="예: 5.18.0" 
                                class="w-full px-4 py-2.5 bg-white border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-slate-800 placeholder-slate-400">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">파일 선택 *</label>
                            <input type="file" name="file" required 
                                class="w-full px-4 py-2 bg-white border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-slate-600 file:mr-4 file:py-1 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                    </div>
                    <button type="submit" class="w-full px-5 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-xl font-medium transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                        <i class="fas fa-upload"></i>
                        업로드
                    </button>
                </form>
            </div>
            {% else %}
            <div class="bg-amber-50 px-6 py-4 border-t border-amber-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-lock text-amber-600"></i>
                    </div>
                    <div>
                        <p class="text-amber-800 font-medium">로그인이 필요합니다</p>
                        <p class="text-amber-600 text-sm">산출물을 업로드하려면 먼저 로그인해주세요.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
[x-cloak] { display: none !important; }
</style>