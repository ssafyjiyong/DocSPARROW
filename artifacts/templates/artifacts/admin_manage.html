{% extends "artifacts/base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fas fa-tools text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-slate-800">관리자 페이지</h1>
                <p class="text-slate-500">카테고리 및 제품 관리</p>
            </div>
        </div>
    </div>

    <!-- Category Management Section -->
    <div class="mb-8 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/50 overflow-hidden"
         x-data="categoryManager()">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-folder-open text-white text-xl"></i>
                <h2 class="text-xl font-bold text-white">카테고리 관리</h2>
            </div>
            <button @click="openCreateModal()" 
                    class="px-4 py-2 bg-white hover:bg-slate-50 text-blue-600 rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <i class="fas fa-plus"></i> 새 카테고리
            </button>
        </div>
        
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">카테고리명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">정렬 순서</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">작업</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        {% for category in categories %}
                        <tr class="hover:bg-blue-50/50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-file-lines text-slate-400"></i>
                                    <span class="text-sm font-medium text-slate-900">{{ category.name }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-slate-600">{{ category.display_order }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button @click="openEditModal({{ category.id }}, '{{ category.name|escapejs }}', {{ category.display_order }})"
                                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                                    <i class="fas fa-edit"></i> 수정
                                </button>
                                <button @click="deleteCategory({{ category.id }}, '{{ category.name|escapejs }}')"
                                        class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i> 삭제
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-6 py-8 text-center text-slate-500">
                                <i class="fas fa-inbox text-3xl mb-2 block text-slate-300"></i>
                                등록된 카테고리가 없습니다.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Category Modal -->
        <div x-show="showModal" 
             x-cloak
             @keydown.escape.window="showModal = false"
             class="fixed inset-0 z-50 overflow-y-auto" 
             style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div @click="showModal = false" class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>
                
                <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800" x-text="isEdit ? '카테고리 수정' : '새 카테고리 등록'"></h3>
                        <button @click="showModal = false" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="saveCategory()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-tag mr-1"></i> 카테고리명
                                </label>
                                <input type="text" 
                                       x-model="formData.name" 
                                       required
                                       class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="카테고리명을 입력하세요">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-sort-numeric-down mr-1"></i> 정렬 순서
                                </label>
                                <input type="number" 
                                       x-model="formData.display_order" 
                                       required
                                       class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="0">
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="submit"
                                    :disabled="saving"
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg disabled:opacity-50">
                                <i class="fas fa-save mr-1"></i>
                                <span x-text="saving ? '저장 중...' : '저장'"></span>
                            </button>
                            <button type="button" 
                                    @click="showModal = false"
                                    class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors">
                                취소
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Management Section -->
    <div class="mb-8 bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/50 overflow-hidden"
         x-data="productManager()">
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-cube text-white text-xl"></i>
                <h2 class="text-xl font-bold text-white">제품 관리</h2>
            </div>
            <button @click="openCreateModal()" 
                    class="px-4 py-2 bg-white hover:bg-slate-50 text-purple-600 rounded-lg text-sm font-medium transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <i class="fas fa-plus"></i> 새 제품
            </button>
        </div>
        
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">제품명</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">색상</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">정렬 순서</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">작업</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        {% for product in products %}
                        <tr class="hover:bg-purple-50/50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-cube text-slate-400"></i>
                                    <span class="text-sm font-medium text-slate-900">{{ product.name }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 {{ product.color_class }} rounded-md shadow-sm"></div>
                                    <span class="text-xs text-slate-600 font-mono">{{ product.color_class }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-slate-600">{{ product.display_order }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button @click="openEditModal({{ product.id }}, '{{ product.name|escapejs }}', '{{ product.color_class }}', {{ product.display_order }})"
                                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                                    <i class="fas fa-edit"></i> 수정
                                </button>
                                <button @click="deleteProduct({{ product.id }}, '{{ product.name|escapejs }}')"
                                        class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i> 삭제
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-slate-500">
                                <i class="fas fa-inbox text-3xl mb-2 block text-slate-300"></i>
                                등록된 제품이 없습니다.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Product Modal -->
        <div x-show="showModal" 
             x-cloak
             @keydown.escape.window="showModal = false"
             class="fixed inset-0 z-50 overflow-y-auto" 
             style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div @click="showModal = false" class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>
                
                <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800" x-text="isEdit ? '제품 수정' : '새 제품 등록'"></h3>
                        <button @click="showModal = false" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="saveProduct()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-tag mr-1"></i> 제품명
                                </label>
                                <input type="text" 
                                       x-model="formData.name" 
                                       required
                                       class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       placeholder="제품명을 입력하세요">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-palette mr-1"></i> 색상 선택
                                </label>
                                <div class="space-y-2">
                                    <select x-model="formData.color_class" 
                                            required
                                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="">색상을 선택하세요</option>
                                        <option value="bg-green-500">녹색 (Green)</option>
                                        <option value="bg-red-500">빨강 (Red)</option>
                                        <option value="bg-indigo-600">인디고 (Indigo)</option>
                                        <option value="bg-orange-500">주황 (Orange)</option>
                                        <option value="bg-yellow-500">노랑 (Yellow)</option>
                                        <option value="bg-blue-500">파랑 (Blue)</option>
                                        <option value="bg-green-600">진녹색 (Dark Green)</option>
                                        <option value="bg-blue-600">진파랑 (Dark Blue)</option>
                                        <option value="bg-teal-500">청록 (Teal)</option>
                                        <option value="bg-purple-500">보라 (Purple)</option>
                                    </select>
                                    <div x-show="formData.color_class" class="flex items-center gap-2 p-3 bg-slate-50 rounded-lg">
                                        <span class="text-sm text-slate-600">미리보기:</span>
                                        <div :class="formData.color_class" class="w-8 h-8 rounded-md shadow-md"></div>
                                        <span class="text-xs text-slate-500 font-mono" x-text="formData.color_class"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-sort-numeric-down mr-1"></i> 정렬 순서
                                </label>
                                <input type="number" 
                                       x-model="formData.display_order" 
                                       required
                                       class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       placeholder="0">
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="submit"
                                    :disabled="saving"
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg disabled:opacity-50">
                                <i class="fas fa-save mr-1"></i>
                                <span x-text="saving ? '저장 중...' : '저장'"></span>
                            </button>
                            <button type="button" 
                                    @click="showModal = false"
                                    class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors">
                                취소
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
function categoryManager() {
    return {
        showModal: false,
        isEdit: false,
        saving: false,
        formData: {
            id: null,
            name: '',
            display_order: 0
        },
        
        openCreateModal() {
            this.isEdit = false;
            this.formData = { id: null, name: '', display_order: 0 };
            this.showModal = true;
        },
        
        openEditModal(id, name, displayOrder) {
            this.isEdit = true;
            this.formData = { id, name, display_order: displayOrder };
            this.showModal = true;
        },
        
        async saveCategory() {
            this.saving = true;
            const url = this.isEdit 
                ? `/manage/category/${this.formData.id}/update/`
                : '/manage/category/create/';
            
            const formData = new FormData();
            formData.append('name', this.formData.name);
            formData.append('display_order', this.formData.display_order);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('저장에 실패했습니다.', 'error');
            } finally {
                this.saving = false;
            }
        },
        
        async deleteCategory(id, name) {
            if (!confirm(`"${name}" 카테고리를 삭제하시겠습니까?`)) return;
            
            try {
                const response = await fetch(`/manage/category/${id}/delete/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('삭제에 실패했습니다.', 'error');
            }
        }
    };
}

function productManager() {
    return {
        showModal: false,
        isEdit: false,
        saving: false,
        formData: {
            id: null,
            name: '',
            color_class: '',
            display_order: 0
        },
        
        openCreateModal() {
            this.isEdit = false;
            this.formData = { id: null, name: '', color_class: '', display_order: 0 };
            this.showModal = true;
        },
        
        openEditModal(id, name, colorClass, displayOrder) {
            this.isEdit = true;
            this.formData = { id, name, color_class: colorClass, display_order: displayOrder };
            this.showModal = true;
        },
        
        async saveProduct() {
            this.saving = true;
            const url = this.isEdit 
                ? `/manage/product/${this.formData.id}/update/`
                : '/manage/product/create/';
            
            const formData = new FormData();
            formData.append('name', this.formData.name);
            formData.append('color_class', this.formData.color_class);
            formData.append('display_order', this.formData.display_order);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('저장에 실패했습니다.', 'error');
            } finally {
                this.saving = false;
            }
        },
        
        async deleteProduct(id, name) {
            if (!confirm(`"${name}" 제품을 삭제하시겠습니까?`)) return;
            
            try {
                const response = await fetch(`/manage/product/${id}/delete/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    showNotification(result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('삭제에 실패했습니다.', 'error');
            }
        }
    };
}

function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 flex items-center gap-2 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    } text-white font-medium animate-fade-in`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
